# ุฑุงูููุง ุฌุงูุน ุจุฑูุงููโููุณ Async ู Parallel ุฏุฑ ูพุงุชูู ๐๐โ

![ุฆุฑููุงู ุฏุงฺฉูููุช](images/document_image.jpg)

## ููุฏูู

ุงู ุฏุงฺฉูููุช ุจู ููุธูุฑ ุขููุฒุด ููุงูู ุจุฑูุงููโููุณ ููุฒูุงู (Async) ู ููุงุฒโุณุงุฒ (Parallel) ุฏุฑ ุฒุจุงู ุจุฑูุงููโููุณ ูพุงุชูู ุชุฏูู ุดุฏู ุงุณุช. ูุทุงูุจ ุงู ุณูุฏ ุจุฑ ุงุณุงุณ ุฏูุฑู ุขููุฒุด ุงุณุชุงุฏ ุงุฑุฏูุฎุงู ุฏุฑ ูุจโุณุงุช ุชุงูพ ูุฑูุ [ุขููุฒุด ุฌุงูุน Async ู Parallel ุฏุฑ Python](https://toplearn.com/c/6140)ุ ุชูู ุดุฏู ุงุณุช. ูุฏู ุงู ุฏุงฺฉูููุช ูุฑุงูู ุขูุฑุฏู ุฏุฑฺฉ ุนููโุชุฑ ุงุฒ ุชฺฉูฺฉโูุง ู ุงุจุฒุงุฑูุง ูุฑุชุจุท ุจุง Async ู Parallel ุฏุฑ ูพุงุชูู ูโุจุงุดุฏ.

ุฏุฑ ุงู ุฏุงฺฉูููุชุ ุจู ุชุดุฑุญ ููุงูู ูพุงูุ ุชฺฉูฺฉโูุง ุจุฑูุงููโููุณุ ู ุงุฑุงุฆู ูุซุงูโูุง ุนูู ูพุฑุฏุงุฎุชู ุฎูุงูุฏ ุดุฏ ุชุง ุดูุง ุจุชูุงูุฏ ุฏุฑ ูพุฑูฺูโูุง ูุงูุน ุฎูุฏ ุจูโุทูุฑ ูุคุซุฑ ุงุฒ ุงู ููุงูู ุจูุฑูโุจุฑุฏุงุฑ ฺฉูุฏ. 

ุจุฏู ุงุณุช ฺฉู ุจุฑุง ุฏุฑฺฉ ุจูุชุฑ ูุทุงูุจุ ุฏุงุดุชู ุฏุงูุด ุงููู ุงุฒ ุฒุจุงู ูพุงุชูู ู ุชฺฉูฺฉโูุง ุจุฑูุงููโููุณ ุจุณุงุฑ ฺฉูฺฉโฺฉููุฏู ุฎูุงูุฏ ุจูุฏ. 

ุขููุฒุด Async ูโุชูุงูุฏ ุจู ุจูุจูุฏ ฺฉุงุฑุง ุจุฑูุงููโูุง ู ุงูุฒุงุด ุณุฑุนุช ุงุฌุฑุง ูุฑุขูุฏูุง ููุฒูุงู ฺฉูฺฉ ฺฉูุฏุ ุจู ุฎุตูุต ุฏุฑ ูพุฑูฺูโูุง ฺฉู ุดุงูู ูุฑูุฏ/ุฎุฑูุฌ ุบุฑููุฒูุงู ู ุจุงุฑูุง I/O-bound ูุณุชูุฏ.

ุงูุฏูุงุฑู ฺฉู ุจุง ูุทุงูุนู ุงู ุฏุงฺฉูููุชุ ุชูุงูุงโูุง ุจุฑูุงููโููุณ ุฎูุฏ ุฑุง ุฏุฑ ุฒููู Async ู Parallel ุชูุณุนู ุฏูุฏ ู ุงุฒ ูุฒุงุง ุจุงูุง ุงู ุชฺฉูฺฉโูุง ุฏุฑ ูพุฑูฺูโูุง ุฎูุฏ ุจูุฑูโููุฏ ุดูุฏ.

---

### ูพุด ูุงุฒ: ูพุงุชูู 3.5 ุจู ุจุนุฏ

---
### ุฌูุณู 2
ฺฉุฏ ุฒุฑ ุฑู ุฏุฑ ูุธุฑ ุจฺฏุฑุฏ:
```python
x = 10
while True:
  x += 1
  print(x)
```

### ุนฺฉุณ ูุจู ุงุฒ ุงุฌุฑุง
![ุนฺฉุณ ูุจู ุงุฒ ุงุฌุฑุง](images/cpu-01.png)

### ุนฺฉุณ ููฺฏุงู ุงุฌุฑุง
![ุนฺฉุณ ููฺฏุงู ุงุฌุฑุง](images/cpu-02.png)

ูฺฉุชู ูุงุจู ุชูุฌู ุงู ุงุณุช ฺฉู ุจุนุฏ ุงุฒ ุงุฌุฑุง ุงู ุญููู ุจ ููุงุช, ุณุณุชู ุงุฒ ุชูุงู ุธุฑูุช ูพุฑุฏุงุฒุด ุฎูุฏ ุงุณุชูุงุฏู ูฺฉุฑุฏู ุงุณุช.
ุงุฒ 14 ูุณุชู CPU ุชููุง 1 ูุณุชู ุฏุฑฺฏุฑ ูพุฑุฏุงุฒุด ูุดูุฏ.

ููฺฏุงู ฺฉู ุงุฒ ุจุฑูุงูู ููุณ Async ุงุณุชูุงุฏู ูฺฉูู, ุณุฑุนุช ุจู ุงูุฏุงุฒู ุชุนุฏุงุฏ ูุณุชู ูุง CPU ูุง ุงูุฒุงุด ูพุฏุง ููฺฉูุฏ! ุจูฺฉู ุจุฎุด ูุง ุงุฒ ูุฑุขูุฏ ุนููุงุช ูุง ฺฉู ูุชูุงููุฏ ููุงุฒ ุงูุฌุงู ุดููุฏ, ููุงุฒ ุจุง ูุฑุขูุฏ ุงุตู ุงูุฌุงู ูุดููุฏ.

ุจุฑุง ูุซุงู ููฺฏุงู ฺฉู ุฏุฑ ฺฉ ุณุงุช ูุฑูุดฺฏุงู ุดูุง ุตูุญู ูุญุตูู ุฑุง ุจุงุฒ ูฺฉูุฏ ู ุขู ุฑุง ุจู ุณุจุฏ ุฎุฑุฏ ุฎูุฏ ุงุถุงูู ูฺฉูุฏ ู ุณูพุณ ุจู ุฏุฑฺฏุงู ูพุฑุฏุงุฎุช ูุฑูุฏ ุชุง ูพุฑุฏุงุฎุช ฺฉูุฏุ ุฏุฑ ุงู ูุฑุขูุฏ ูฺ ุจุฎุด ููุชูุงูุฏ ููุงุฒ ุงูุฌุงู ุดูุฏุ ุจูฺฉู ุจุงุฏ ุจู ุชุฑุชุจ ุงูุฌุงู ุดูุฏ.

ูู ฺฉุงุฑูุง ูุงููุฏ ุงุฑุณุงู ุงูู ุง ูพุงูฺฉ ุชุงุฏ ูพุฑุฏุงุฎุช ู... ุฑุง ูุชูุงูุฏ ููุงุฒ ุจุง ูุฑุขูุฏ ุซุจุช ุณูุงุฑุด ุงูุฌุงู ุฏูุฏ.

---
### ุฌูุณู 3
### Sync VS Async
![sync](images/sync.png)
![Async](images/Async.png)

ุฏุฑุญุงูุช sync ููฺฏุงู ฺฉู ฺฉ ุชุณฺฉ ุฏุฑุญุงู ุงุฌุฑุง ุงุณุชุ ุงฺฏุฑ ุชุณฺฉ ุฏฺฏุฑ ูุงุฑุฏ ุจุดูุฏุ ุจุงุฏ ููุชุธุฑ ุจูุงูุฏ ุชุง ูุฑุขูุฏ ุชุณุช ูุจู ุงูุฌุงู ุดูุฏ ุชุง ููุจุช ุจู ุงูุฌุงู ุขู ุจุฑุณุฏ.

ุงูุง ุฏุฑ ุจุฑูุงูู ููุณ Async ููฺฏุงู ฺฉู ฺฉ ุชุณฺฉ ุดุฑูุน ูุดูุฏ ุฏุฑ ูุถุง ThreadPool ุฑูุง ูุดูุฏ ุชุง ุงูุฌุงู ุดูุฏ. ุฏุฑููู ููฺฏุงู ุณุฑุงุบ ุชุณฺฉ ุจุนุฏ ูุฑูุฏ.

---
### ุฌูุณู 4
### GIL (Global Interpreter Lock)

ุจุฑุง ุฏุฑฺฉ ุนูู ุฑุงุฌุจ GIL ูุชูุงูุฏ ุงุฒ [ุงู ููุงูู](https://realpython.com/python-gil/) ุงุณุชูุงุฏู ฺฉูุฏ.


### ูุญูู ฺฉุงุฑ async ุฏุฑ ฺฉ Thread ูพุงุชูู !

![Async](images/async-in-python.png)

ุชูุฌู ฺฉูุฏ ฺฉู ุงู ูุฑุขูุฏ ุจุฑุง ฺฉ Thread ุฏุฑ ูพุงุชูู ุงูุฌุงู ูุดูุฏ !

ูฺฉุชู ููู ุฏุฑ ุงู ููุถูุน ุงู ุงุณุช ฺฉู ูุฑฺฉุฏุงู ุงุฒ ูุณุชู ูุง CPU ูุชูุงูุฏ ุฎูุฏ ุจู ุงู ุตูุฑุช ฺฉุงุฑ ฺฉููุฏ.

---
### ุฌูุณู 5
ุจุง ุงุณุชูุงุฏู ุงุฒ Generator ูุง ุฏุฑ ุฒุจุงู ูพุงุชูู ูุชูุงูู ููุชุธุฑ ุงุชูุงู ูุฑุขูุฏ ฺฉ ุชุงุจุน ููุงูู ู ุฏุฑ ูุฑ ูุฑุญูู ูุชุฌู ุฑุง yeald ฺฉูู.

ุจู ุงู ฺฉุฏ ุชูุฌู ฺฉูุฏ:

```python
def fib():
  # 0, 1, 1, 2, 3, 5, ...

  current, nxt = 0, 1
  while True:
    current, nxt = nxt, current + nxt
    yield current

result = fib()

for item in result:
  if item > 1000:
    break
  
  print(item, end=", ")
```

ุฎุฑูุฌ ุงู ฺฉุฏ ุจู ุตูุฑุช ุฒุฑ ุงุณุช:

```bash
1, 1, 2, 3, 5, 8, 13, 21, 34, 55, 89, 144, 233, 377, 610, 987, 
```

ุฏุฑ ูพุงุชููุ Generatorูุง ุชูุงุจุน ูุณุชูุฏ ฺฉู ุจู ุฌุง ุจุงุฒฺฏุฑุฏุงูุฏู ฺฉ ููุฏุงุฑ ุจุง ุงุณุชูุงุฏู ุงุฒ returnุ ูุชูุงููุฏ ุฏุฑ ูุฑ ูุฑุงุฎูุงู ุฎุฑูุฌ ููุงู ูุฑุญูู ุฑุง ูุญุงุณุจู ู ุจุงุฒฺฏุฑุฏุงูุฏู.

ูฺฉุชู ููู ุฏุฑ ุงุณุชูุงุฏู ุงุฒ Generatorูุง ุงู ุงุณุช ฺฉู Generatorูุง ููุฏุงุฑ ูุฑุญูู ูุจู ุฑุง ุฏุฑ ุฎูุฏ ุฐุฎุฑู ูฺฉููุฏ.

ุจุฑุง ุงุณุชูุงุฏู ุงุฒ Generatorูุง ูุชูุงูู ุจู ุฏู ุตูุฑุช ุนูู ฺฉูู:

1- ุจุง ุงุณุชูุงุฏู ุงุฒ ุฏุณุชูุฑ `()next`
```python
result = fib()

print(next(result))
```

```bash
> 1
```

2- ูุฑุงุฎูุงู ุฏุฑ ฺฉ ุญููู
```python
result = fib()

for item in result:
    print(item, end=", ")
```

```bash
> 1, 1, 2, 3, ...
```

#### ุฏูู ุงููุช Generatorูุง ุฏุฑ ูุจุญุซ Async:
ฺฉ ุงุฒ ุฎุตูุตุงุช ุงุตู ฺฉู ูพฺฉุฌ AsyncIo ุฏุฑ ูพุณ ุฒููู ุงุฒ ุขู ุงุณุชูุงุฏู ูฺฉูุฏุ ูุจุญุซ Generatorูุง ุงุณุช. ุจู ููู ุฏูู ุฏุฑฺฉ ุณุงุฎุชุงุฑ Generatorูุง ุงุฒ ุงููุช ุจุงูุง ุจุฑุฎูุฑุฏุงุฑ ุงุณุช.

---
### ุฌูุณู 7

ุฏุฑ ุงูุฌุง ฺฉ ุชุณฺฉ ุฑุง ุจู ุตูุฑุช sync ู async ูพุงุฏู ุณุงุฒ ฺฉุฑุฏู ุงู.
ุฏุฑ ุงู ูุซุงู ุณุน ฺฉุฑุฏู ุงู ูุฑุขูุฏ ุงุณฺฉุฑูพ ฺฉุฑุฏู ุฏุชุง ุงุฒ ุณุงุช ุฑุง ุดุจู ุณุงุฒ ฺฉูู.

[ูุดุงูุฏู ฺฉุฏ sync](./codes/sync_scraper_task.py)

[ูุดุงูุฏู ฺฉุฏ async](./codes/async_scraper_task.py)

ูุฏุช ุฒูุงู ุงูุฌุงู ุงู ุชุณฺฉ ุจู ุตูุฑุช sync ุจุฑุงุจุฑ ุจุง 24 ุซุงูู ุจูุฏ ุงูุง ุงูุฌุงู ุงู ุชุณฺฉ ุจู ุตูุฑุช async ุฏุฑ 13 ุซุงูู ุงูุฌุงู ุดุฏู ุงุณุช.

ุงู ุงุฎุชูุงู ุจู ุงู ุฏูู ุงุณุช ฺฉู ุฏุฑ ุฑูุด sync ุจุงุฏ ุงุจุชุฏุง ููู url ูุง ุงุณฺฉุฑูพ ุจุดูุฏ ู ุฏุฑ ฺฉ ูุณุช ุฐุฎุฑู ุดูุฏุ ุณูพุณ ูุฑุขูุฏ ูพุฑุฏุงุฒุด ุขู ุงูุฌุงู ุดูุฏ.

ุงูุง ุฏุฑ ุฑูุด async ููุฒูุงู ุจุง ุงุณฺฉุฑูพ ฺฉุฑุฏู ฺฉ ุตูุญูุ ูพุฑุฏุงุฒุด ุขู ูุฒ ุงูุฌุงู ูุดูุฏ.

ูฺฉุงุช ูุงู ุชูุฌู ุฏุฑ ฺฉุฏ async:


1- ุฏุฑ `print` ฺฉ `flush=True` ูุฑุงุฑุฏุงุฏู ุดุฏู ุชุง ุจู ุณุฑุนุช ูพุฑูุช ุดูุฏ.

2- ุจุง ุงุณุชูุงุฏู ุงุฒ `data = asyncio.Queue()` ฺฉ ุตู ุงุฌุงุฏ ูฺฉูู.

3- ุจู ุตูุฑุช ุฒุฑ ุชูุงุจุน ุฑู ุจู ุชุณฺฉ ุชุจุฏู ูฺฉูู:
```python
task_1 = asyncio.create_task(scrap_data(20, data))
task_2 = asyncio.create_task(process_data(20, data))
```
ุชูุฌู: ุจุฑุง ุชุจุฏู ุชุงุจุน ุจู ุชุณฺฉุ ุจุงุฏ ุชุงุจุน async ุจุงุดุฏ. (ุฏุฑ ุงุจุชุฏุง ุขู async ุจฺฏุฐุงุฑุฏ)

4- ุจุง ุงุณุชูุงุฏู ุงุฒ `asyncio.gather()` ุชุณฺฉ ูุงุฑู ุงุฌุฑุง ูฺฉูู.

```python
await asyncio.gather(task_1, task_2)
```


5- ุจุฑุง ฺฉุงุฑ ุจุง `asyncio.Queue()`ูุง ุงุฒ `put()` ู `get()` ุงุณุชูุงุฏู ูฺฉูู.

6- ุจุฑุง ุงุฌุงุฏ `sleep` ุงุฒ `asyncio.sleep()` ุงุณุชูุงุฏู ูฺฉูู.

7- ุจุฑุง ุงุฌุฑุง ุงู ูุงู ุจู ุตูุฑุช async ุจู ุตูุฑุช ุฒุฑ ุนูู ูฺฉูู:
```python
if __name__ == "__main__":
    asyncio.run(main())
```

8- ุงุฒ ูพุงุชูู `3.10` ุจู ุจุนุฏุ ุงุณุชูุงุฏู ูุณุชูู ุงุฒ `get_event_loop()` ุชูุตู ููโุดูุฏ ู ููฺฉู ุงุณุช `DeprecationWarning` ุฏุฑุงูุช ฺฉูุฏ. ุจูุชุฑ ุงุณุช ุงุฒ `asyncio.run(say_hello())` ุงุณุชูุงุฏู ฺฉูู.

#### ุชูุงูุช `time.sleep()` ู `asyncio.sleep()`
ููุงูุทูุฑ ฺฉู ฺฏูุชูุ ุฏุฑ ูพุงุชูู ฺฉ `Thread` ูุฌูุฏ ุฏุงุฑุฏ ฺฉู ูุธูู ุงูุฌุงู ฺฉุฏูุงุฑู ุจุฑุนูุฏู ุฏุงุฑุฏ. ููฺฏุงู ฺฉู ฺฉุฏ ุจู ุตูุฑุช sync ููุดุชู ูุดูุฏุ ุงู ฺฉุฏ ุจู ุตูุฑุช ุฎุท ุจู ุฎุท ุงุฌุฑุง ูุดูุฏ. ููฺฏุงู ฺฉู ฺฉุฏ ุจู ุตูุฑุช async ููุดุชู ุดูุฏุ ุฏุฑ ุจุฎุด ูุง ุงุฒ ฺฉุฏ (ูุงููุฏ ุงุชุตุงู ุจู ุฏุชุงุจุณ ู ุง ุฎูุงูุฏู ูุงู ู...) ุงู  `Thread` ุงูุฌุงู ุงู ุชุงุจุน ุฑู ุฑูุง ูฺฉูู ู ุจู ุณุฑุงุบ ุชุณฺฉ ุจุนุฏ ูุฑูุฏ. ุงฺฏุฑ ุฏุฑ ฺฉุฏ async ุงุฒ `time.sleep()` ุงุณุชูุงุฏู ฺฉููุ ููฺฏุงู ููุงุฌู ุดุฏู ุจุง ุขูุ `Thread` ููุชุธุฑ ููุงูุฏ. ุงุตุทูุงุญุง ููู ูุดูุฏ. ุจูุงุจุฑุงู ุจุฑุง ุงูฺฉู ุงู ุตุจุฑฺฉุฑุฏู ุฏุฑ ูพุณ ุฒููู ุงูุฌุงู ุดูุฏุ ุจุงุฏ ุงุฒ `asyncio.sleep()` ุงุณุชูุงุฏู ฺฉูู.

#### ุงุณุชูุงุฏู ุงุฒ await
ุฏุฑ ุจุฑูุงูู ููุณ async ูุงุฒ ุฏุงุฑู ุชุง ุฏุฑ ุจุฎุด ูุง ุงุฒ ุจุฑูุงูู ููุชุธุฑ ุจูุงูู ุชุง ูุชุฌู ุชุงุจุน ุจุงุฒฺฏุฑุฏุงูุฏู ุดูุฏ. ุงฺฏุฑ ุจู ุตูุฑุช sync ุจููุณูุ ุจุฑูุงูู ูุชููู ูุดูุฏ ุชุง ุงู ูพุฑุฏุงุฒุด ุงูุฌุงู ุดูุฏ. ุงฺฏุฑ ุจู ุตูุฑุช async ุจููุณูุ ุจุงุฏ ุงุฒ `await` ุงุณุชูุงุฏู ฺฉูู ุชุง ุจุฑูุงูู ููุชุธุฑ ุงูุฌุงู ุงู ุชุงุจุน ุจูุงูุฏ **ุงูุง ุฏุฑ ุจฺฉ ฺฏุฑุงูุฏ**! ุจูุงุจุฑุงู ุฏุฑ ุงู ุญู `Thread` ุจู ุงูุฌุงู ุณุงุฑ ุชุณฺฉ ูุง ููพุฑุฏุงุฒุฏ.

ูุฑุงููุด ูุดูุฏ ฺฉู ุงุณุชูุงุฏู ุงุฒ `await` ุชููุง ุฏุฑ ุชูุงุจุน async ูุงู ุงุณุชูุงุฏู ุงุณุช.

---
### ุฌูุณู 8

ุจุง ุงุณุชูุงุฏู ุงุฒ ูพฺฉุฌ `uvloop` ูุชูุงูู ุณุฑุนุช ุงุฌุฑุง ฺฉุฏูุงุฑู ุญุฏูุฏ 2 ุชุง 4 ุจุฑุงุจุฑ ุงูุฒุงุด ุจุฏูู. ุงู ูพฺฉุฌ ุจุง ุงุณุชูุงุฏู ุงุฒ ุฒุจุงู C ูพุงุฏู ุณุงุฒ ุดุฏู ุงุณุช. ุจู ุตูุฑุช ุฒุฑ ูุชูุงูู ุงุฒ ุงู ูพฺฉุฌ ุงุณุชูุงุฏู ฺฉูู.

```python
import asyncio
import uvloop

asyncio.set_event_loop_policy(uvloop.EventLoopPolicy())
```

ุงูุจุชู ุงู ุฑูุด ุฑู ููุฏูุฒ ุงุฌุฑุง ููุดูุฏ.

---
### ุฌูุณู 9

ุจู ุฌุง ุงุณุชูุงุฏู ุงุฒ ูพฺฉุฌ `requests` ุจุงุฏ ุงุฒ `aiohttp` ุงุณุชูุงุฏู ฺฉูู. ุงู ูพฺฉุฌ ุจู ุตูุฑุช async ูพุงุฏู ุณุงุฒ ุดุฏู ุงุณุช.
ุจุฑุง ุงุณุชูุงุฏู ุงุฒ ุงู ูพฺฉุฌ ุจุงุฏ ุจู ุตูุฑุช context manager ุงุณุชูุงุฏู ฺฉูู.

ููููู ฺฉุฏ ุงุณุชูุงุฏู ุงุฒ `aiohttp`:
```python
import aiohttp

async def scrap_url():
	async with aiohttp.ClientSession() as session:
		async with session.get("url") as response:
			return await response.text()
```
[ฺฉุฏ ูุฑุจูุท ุจู ุงุณฺฉุฑูพ ุณุงุช ุชุงูพ ูุฑู ุจู ุตูุฑุช async](./codes/async_scrap.py)

---
### ุฌูุณู 10
ูุนุฑู ฺูุฏ ูพฺฉุฌ ูุญุจูุจ ุงุณุชูุงุฏู ุงุฒ async:

1- aiofiles   
2- umongo   
3- asyncpg  
4- asyncio-redis


### ุงุณุชูุงุฏู ุงุฒ `asyncio` ุง `threads` ุ
ุงฺฏุฑ ุจุฑุง ฺฉุงุฑ ฺฉู ูุฎูุงูู ุงูุฌุงู ุจุฏููุ ูพฺฉุฌ ูุฌูุฏ ุฏุงุฑุฏ ฺฉู ุจู ุตูุฑุช async ูพุงุฏู ุณุงุฒ ุดุฏู ุจุงุดุฏุ ุญุชูุง ุงุฒ asyncio ุงุณุชูุงุฏู ฺฉูู.
ุจุฑุง ูุซุงู ุจู ุฌุง ุงุณุชูุงุฏู ุงุฒ ูพฺฉุฌ requests ฺฉู ุจู ุตูุฑุช sync ุงุณุชุ ูุชูุงูู ุงุฒ ูพฺฉุฌ aiohttp ุงุณุชูุงุฏู ฺฉูู ฺฉู ุจู ุตูุฑุช async ุงุณุช.

ุงูุง ุงฺฏุฑ ูพฺฉุฌ ฺฉู ูุฎูุงูู ุงุฒ ุขู ุงุณุชูุงุฏู ฺฉููุ ุฌุงฺฏุฒู async ูุฏุงุฑุฏุ ุจุงุฏ ุงุฒ `threads` ุงุณุชูุงุฏู ฺฉูู.


### ูุญูู ุงุณุชูุงุฏู ุงุฒ `Threads`
![Async](images/threads.png)

---
### ุฌูุณู 11

ููููู ฺฉุฏ ูพุงุฏู ุณุงุฒ ุจู ุฑูุด `Threading`:
```python
import threading
import time

def main():
    t = threading.Thread(target=greeter, args=("Mohammad", ))
    t.start()
    print("Task Done !")
    

def greeter(name: str, count: int = 10):
    for i in range(count):
        print(f"{i + 1} - Hello {name}")
        time.sleep(1)
        
main()
```

ุฏุฑ ุงู ฺฉุฏ Thread ุงุตู ุงูุฌุงู ูุดูุฏ ู ุฏุฑ ูพุณ ุฒููู ุจู ุตูุฑุช ููุงุฒ ุชุณฺฉ ุงุฌุฑุง ูุดูุฏ.

ุงฺฏุฑ ุจุฎูุงูู ูุฎ ุงุตู ููุชุธุฑ ุชูุงู ุดุฏู ูุฎ ูุง ุฏฺฏุฑ ุจูุงูุฏ ูุชูุงูู ุงุฒ ุฏุณุชูุฑ `t.join()` ุงุณุชูุงุฏู ฺฉูู.

ุงฺฏุฑ ุจุฎูุงูู ุชุณฺฉ ุฏุฑ ุจฺฉ ฺฏุฑุงูุฏ ฺฉุงุฑ ุฑุง ุงูุฌุงู ุจุฏูุฏุ ุจุงุฏ ุฏุฑูู `threading.Thread()` ุงุฒ `daemon=True` ุงุณุชูุงุฏู ฺฉูู.

ูุง ูุชูุงูู ุจู ุตูุฑุช ุฒุฑ ฺูุฏ Thread ุงุฌุงุฏ ฺฉูู:
```python
def main():
    t1 = threading.Thread(target=greeter, args=("Mohammad", ))
    t2 = threading.Thread(target=greeter, args=("Ali", ))
    
    t1.start()
    t2.start()
    
    print("Task Done !")
```
ุจู ุงู ุณุจฺฉ ฺฉู ุฏุฑ ุขู ฺูุฏ Thread ุงุฌุงุฏ ูุดูุฏุ ุจุฑูุงูู ููุณ `multi-thread` ู ฺฏููุฏ.

ุงฺฏุฑ ุจุฎูุงูู ฺูุฏู Thread (ูุซูุง 100 Thread) ุงุฌุงุฏ ฺฉููุ ูุชูุงูู ุขููุง ุฑุง ุฏุฑูู ฺฉ ูุณุช ุงุถุงูู ฺฉูู ู ุจู ุตูุฑุช `List Comprehensions` ุงุฌุงุฏ ู ุงุฌุฑุง ฺฉูู. ุจุฑุง ูุซุงู ุฏุงุฑู:

```python
def main():
    
    threads = [
    	threading.Thread(target=greeter, args=("Mohammad", )),
    	threading.Thread(target=greeter, args=("Ali", )) 
	]
    
    [t.start() for t in threads]
    
    [t.join() for t in threads]

    print("Task Done !")
```
---
### ุฌูุณู 12

ุงฺฏุฑ Thread ูุง ุฏุฑ ูพุณ ุฒููู ุงุฌุงุฏ ูฺฉูุฏุ ูุชูุงูุฏ ุงุฒ ุงู ุฑูุด ุจุฑุง ูุชููู ฺฉุฑุฏู ุขููุง ุงุณุชูุงุฏู ฺฉูุฏ.

[ุฑูุด ูุชููู ฺฉุฑุฏู Threadูุง](./codes/canceling_thread.py)

---
### ุฌูุณู 13

### ูฺฉุชู ููู ุฏุฑ ุงุณุชูุงุฏู ุงุฒ ุฑูุด ูุง multi-thread ู async !
ุฑูุด ูุง ฺฉู ุชุง ุงูุงู ุจุฑุฑุณ ฺฉุฑุฏูุ ุจุฑุง ูพุฑุฏุงุฒุด ูุง ููุฏ ุงุณุช ฺฉู I/O bound ูุณุชูุฏ.
ุงฺฏุฑ ุจุฎูุงูู ูุฑุจุน ุงุนุฏุงุฏ 1 ุชุง 50.000.000 ุฑู ุญุณุงุจ ฺฉููุ ฺูู ุงุฒ ููุน CPU bound ุงุณุชุ ุชุงุซุฑ ุฏุฑ ุงูุฒุงุด ุณุฑุนุช ุงุฌุฑุง ูุญุงุณุจุงุช ูุฏุงุฑุฏ !

ุฏูู ุงู ุงุชูุงู ุงู ุงุณุช ฺฉู ููุณุฑ ูพุงุชูู ุฏุฑ ูุฑ ูุญุธู ุชููุง ฺฉ ุนููุงุช ุฑุง ุงูุฌุงู ูุฏูุฏ ู ุงฺฏุฑ multi-thread ูู ูพุงุฏู ุณุงุฒ ุดูุฏุ ุจุงุฒ ูู ุจู ุชุฑุชุจ ูุญุงุณุจู ูุดูุฏ.

---
### ุฌูุณู 14

### ุขุดูุง ุจุง ูุจุญุซ ููู `race condition` !

ฺฉุฏ ุฒุฑ ุฑู ุฏุฑ ูุธุฑ ุจฺฏุฑุฏ:

[ูุซุงู ุฑุฒุฑู ุตูุฏู ู ุจุฑูุฒ race condition](./codes/race_condition.py)

ุฎุฑูุฌ ฺฉุฏ ุจุงูุง ุฏุฑ ููุงูุน ููฺฉู ุงุณุช ุจู ุตูุฑุช ุฒุฑ ุจุงุดุฏ:

```bash
2 seats booked successfully for Mohammad 

2 seats booked successfully for Ali

Available seats: -2
```

ุงู ูุดฺฉู ุจู ุงู ุฏูู ุฑุฎ ูุฏูุฏ ฺฉู ุฏู thread ููุฒูุงู ูุตุฏ ุงุณุชูุงุฏู ุงุฒ ฺฉ ููุจุน ุฑุง ุฏุงุฑูุฏ. ุชูุถุญุงุช ุจุดุชุฑ ุชูุณุท ููุด ูุตููุน ุฏุฑ ุฒุฑ ุขูุฏู ุงุณุช:

```
ุฒูุงู ุงุชูุงู ูโุงูุชุฏ ฺฉู ฺูุฏู ุจุฑูุงูู ุง ูุธูู (coroutine) ููุฒูุงู ุจู ฺฉ ุจุฎุด ูุดุชุฑฺฉ ุงุฒ ุญุงูุธู ุง ุฏุงุฏูโูุง ุฏุณุชุฑุณ ุฏุงุดุชู ุจุงุดูุฏ ู ูุชุฌู ููุง ุจุณุชฺฏ ุจู ุชุฑุชุจ ุงุฌุฑุง ุขูโูุง ุฏุงุฑุฏ. ุงู ูุถุนุช ููฺฉู ุงุณุช ุจุงุนุซ ูุดฺฉูุงุช ุบุฑูุงุจู ูพุดโุจู ู ุฎุทุงูุง ุณุฎุช ุดูุฏ.

ูุซูุงูุ ุงฺฏุฑ ุฏู ูุธูู ุจุฎูุงููุฏ ููุฒูุงู ููุฏุงุฑ ฺฉ ูุชุบุฑ ุฑุง ุชุบุฑ ุฏููุฏุ ููฺฉู ุงุณุช ฺฉ ููุฏุงุฑ ูุจู ุฑุง ุจุฎูุงูุฏุ ูุจู ุงุฒ ุจูโุฑูุฒุฑุณุงูุ ูุธูู ุฏฺฏุฑ ุขู ุฑุง ุชุบุฑ ุฏูุฏ ู ุฏุฑ ูุชุฌูุ ุฏุงุฏู ูุงุฏุฑุณุช ุญุงุตู ุดูุฏ.
```

---
### ุฌูุณู 15
### ุงุณุชูุงุฏู ุงุฒ `Lock` ุจุฑุง ุฌููฺฏุฑ ุงุฒ `race condition`

ุจุฑุง ุงูฺฉู ููุฒูุงู ฺูุฏ thread ุจู ฺฉ ูุชุบุฑ ุง ููุจุน ุฏุณุชุฑุณ ูุฏุงุดุชู ุจุงุดูุฏ ฺฉู ุจุงุนุซ ุจุฑูุฒ race condition ุดูุฏุ ุงุฒ lock ุงุณุชูุงุฏู ูฺฉูู.

ุงุณุชูุงุฏู ุงุฒ lock ุจุงุนุซ ูุดูุฏ ุชุง ุจุฎุด ุงุฒ ฺฉุฏ ฺฉู ุจุฑุง ุชุบุฑ ุง ููุฏุงุฑุฏู ฺฉ ูุชุบุฑ ุงุณุช ููู ุดูุฏ ู ุณุงุฑ thread ูุง ุจู ุขู ุฏุณุชุฑุณ ูุฏุงุดุชู ุจุงุดูุฏ.

ุจุฑุง ฺฉุงุฑ ุจุง Lock ุฏู ุฑูุด ูุนุฑู ูุดูุฏ ฺฉู ุฑูุด ุฏูู ูพุดููุงุฏ ูุดูุฏ.

### ุฑูุด ุงูู: ุงุณุชูุงุฏู ุจู ุตูุฑุช ุฏุณุช

```python
class Movie:
    def __init__(self):
        self.lock = threading.Lock()
    
    def booking(self, number_of_seats):
        global available_seats
        
        self.lock.acquire()
		
		try:
			if number_of_seats <= available_seats:
				print(f'{number_of_seats} seats booked successfully for {threading.current_thread().name} \n')
				available_seats -= number_of_seats

			elif number_of_seats > available_seats:
				print(f'{threading.current_thread().name}, number of seats that you want is greater than available seats')

			else:
				print('All seats are sold out')
				
		except Exception as e:
			print(e)
		
		finally:
			self.lock.release()
```
ุฏุฑ ุงู ุฑูุด ุงฺฏุฑ ูุฑุงููุด ุดูุฏ ฺฉู `lock` ุฑุง `release` ฺฉููุ ุจุฑูุงูู `Deadlock` ูุดูุฏ.

### ุฑูุด ุฏูู: ุงุณุชูุงุฏู ุจู ุตูุฑุช context manager
```python
class Movie:
    def __init__(self):
        self.lock = threading.Lock()
    
    def booking(self, number_of_seats):
        global available_seats
        
        with self.lock:		
			try:
				if number_of_seats <= available_seats:
					print(f'{number_of_seats} seats booked successfully for {threading.current_thread().name} \n')
					available_seats -= number_of_seats

				elif number_of_seats > available_seats:
					print(f'{threading.current_thread().name}, number of seats that you want is greater than available seats')

				else:
					print('All seats are sold out')
					
			except Exception as e:
				print(e)
```

---
### ุฌูุณู 16
ุฒูุงู ฺฉู ฺฉ thread ุจู ุฏุณุชูุฑ `self.lock.acquire()` ูุฑุณุฏุ ุชูุงู thread ูุง ููู ูุดููุฏุ ุชุง ุฒูุงู ฺฉู ุขู thread ุฏุณุชูุฑ `self.lock.release()` ุฑุง ูุฑุงุฎูุงู ฺฉูุฏ.

ูุดฺฉู ฺฉู ูุฌูุฏ ุฏุงุฑุฏ ุงู ุงุณุช ฺฉู ุงฺฏุฑ ุงุชูุงู ุฏู thread ุฏููุง ููุฒูุงู ุจู ุฏุณุชูุฑ `self.lock.acquire()` ุจุฑุณูุฏุ `Deadlock` ุงุชูุงู ู ุงูุชุฏ. ุฒูุงู ฺฉู ุงู ุงุชูุงู ู ุงูุชุฏุ ุณุฑูุฑ ุจุงุฏ ุฑ ุงุณุชุงุฑุช ุดูุฏ ุชุง ุจุชูุงูุฏ ุฏูุจุงุฑู ุดุฑูุน ุจู ฺฉุงุฑ ฺฉูุฏ.

ุฏูู ุงู ุงุชูุงู ุงู ุงุณุช ฺฉู ููุช ุฏู thread ููุฒูุงู ุจู ุฏุณุชูุฑ `self.lock.acquire()` ู ุฑุณูุฏุ ฺฉ thread ุชูุงู threadูุง ุฏฺฏุฑ ุฑู ูุงฺฉ ูฺฉูุฏ ู thread ุฏฺฏุฑ ุงู thread ุฑุง ูุงฺฉ ูฺฉูุฏ.
ุฏุฑ ูุชุฌู ุงู ุงุชูุงูุ ุชูุงู threadูุง ูุงฺฉ ู ุดููุฏ ู `Deadlock` ุงุชูุงู ู ุงูุชุฏ. ุจู ุฒุจุงู ุฏฺฏุฑุ ุฏุณุชูุฑ `self.lock.release()` ูฺ ููุช ูุฑุงุฎูุงู ููุดูุฏ ุชุง thread ูุง ุงุฒ ุญุงูุช ูุงฺฉ ุฎุงุฑุฌ ุดููุฏ.

#### ุขุดูุง ุจุง `RLock` (Reentrant Lock)
ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุงู ุงุชูุงูุ ูพุดููุงุฏ ูุดูุฏ ฺฉู ุงุฒ `RLock` (Reentrant Lock) ุงุณุชูุงุฏู ุดูุฏ.

ุชูุงูุช RLock ุงู ุงุณุช ฺฉู ุจู thread ุงู ุงุฌุงุฒู ุฑุง ูุฏูุฏ ฺฉู ูุงุฑุฏ instance ฺฉู ูุงฺฉ ฺฉุฑุฏู ุงุณุช ูุงุฑุฏ ุดูุฏ. ุจูุงุจุฑุงู ุงฺฏุฑ ฺฉ instance ุชูุณุท ุฏู thread ููู ุดูุฏุ thread ูุชูุงูุฏ ูุงุฑุฏ ุขู ุดูุฏ ู ุฏุณุชูุฑ `self.lock.release()` ุฑุง ุจุฑุง ุขู ูุฑุงุฎูุงู ฺฉูุฏ.

ูฺฉุชู ูุงุจู ุชูุฌู ุงู ุงุณุช ฺฉู ุจู ููุงู ุชุนุฏุงุฏ ฺฉู ุฏุณุชูุฑ `self.lock.acquire()` ูุฌูุฏ ุฏุงุฑุฏุ ุจุงุฏ ุฏุณุชูุฑ `self.lock.release()` ูุฒ ูุฌูุฏ ุฏุงุดุชู ุจุงุดุฏ. ูุฑฺูุฏ ูพุดููุงุฏ ูโุดูุฏ ฺฉู ุงุฒ `context manager` ุงุณุชูุงุฏู ุดูุฏ.

### ุชูุงูุช `Lock` ู 'RLock'
1- ุฏุฑ `Lock` ููฺฏุงู ฺฉู ุดูุง ุฏุณุชูุฑ `acquire()` ุฑุง ูุฑุงุฎูุงู ูฺฉูุฏุ thread ุฏฺฏุฑ ููุชูุงูุฏ ุขู ุฑุง ูุฑุงุฎูุงู ฺฉูุฏ. ุงูุง ุฏุฑ `RLock` ูุฑ ฺูุฏุชุง thread ูุชูุงููุฏ ุงู ฺฉุงุฑ ุขู ุฑุง ูุฑุงุฎูุงู ฺฉููุฏ.

2- ููฺฏุงู ฺฉู ุดูุง ุงุฒ `Lock` ุงุณุชูุงุฏู ูฺฉูุฏุ ูุฑ thread ูุชูุงูุฏ ูุชุฏ `release()` ุฑู ูุฑุงุฎูุงู ฺฉูู. ุงูุง ุฏุฑ `RLock` ูุฑ thread ฺฉู ูุชุฏ `acquire()` ุฑู ูุฑุงุฎูุงู ูฺฉูุฏุ ููุงู thread ุจุงุฏ ูุชุฏ `release()` ุฑู ูุฑุงุฎูุงู ฺฉูู.

3- ุณุฑุนุช `Lock` ุงุฒ `RLock` ุจุดุชุฑ ุงุณุช. (ุงูุง ุงู ุชูุงูุช ุฎู ุจู ฺุดู ููุงุฏ. ุณุฎุช ูฺฏุฑุฏ)

---
### ุฌูุณู 17
ููุงูุทูุฑ ฺฉู ุชูุถุญ ุฏุงุฏูุ ูพุงุชูู ุจู ุฏูู ุทุฑุงุญ ุณุงุฎุชุงุฑ GILุ ุชููุง ุฑู ฺฉ ูุณุชู CPU ุงุฌุฑุง ูุดูุฏ. ุชุง ุจู ุงูุฌุง ูุซุงู ูุง ฺฉู ุชูุถุญ ุฏุงุฏูุ ุณุน ุจุฑ ุงู ุฏุงุดุช ฺฉู ุจุง ุงุณุชูุงุฏู ุงุฒ ุฑูุด ูุง async ู multi-threading ุงุณุชูุงุฏู ุจููู ุชุฑ ุงุฒ ููุงู ฺฉ ูุณุชู CPU ุฏุงุดุชู ุจุงุดู ุชุง ูุฑุขูุฏ ูุง ุจู ุตูุฑุช ููุงุฒ ุงูุฌุงู ุจุดูุฏ.

ุฏุฑ ุงู ุฌูุณู ูุตุฏ ุฏุงุฑู ฺฉู `multi process programming` ุฑุง ูุนุฑู ฺฉูู.

ุจู ุงู ูุซุงู ุชูุฌู ฺฉูุฏ:

[ูุญุงุณุจู sqrt ุงุนุฏุงุฏ 1 ุชุง 50.000.000 ุจู ุตูุฑุช multi-threading](./codes/compute_example.py)

ุฏุฑ ุงู ูุซุงู ุณุน ฺฉุฑุฏู sqrt ุงุนุฏุงุฏ 1 ุชุง 50.000.000 ุฑุง ุจู ุฑูุด multi-threading ุงูุฌุงู ุจุฏูู ุชุง ุณุฑุนุช ุงุฌุฑุง ุจุดุชุฑ ุฏุงุดุชู ุจุงุดุฏ. ุงูุง ุฏุฏู ฺฉู ุจุง ูุฌูุฏ ุงุณุชูุงุฏู ุงุฒ multi-threading ูุญุงุณุจุงุช ุฏุฑ 8 ุซุงูู ุงูุฌุงู ุดุฏ ู ูพุดุฑูุช ูุฏุงุดุช.

ุฏูู ุงู ุงุชูุงู ุงู ุงุณุช ฺฉู ุฏุฑ ูพุงุชูู ุจู ุฏูู ุงุณุชูุงุฏู ุงุฒ ุณุงุฎุชุงุฑ GIL ุฏุฑ ูุฑ ูุญุธู ุชููุง ฺฉ ูุญุงุณุจู ุงูุฌุงู ูุดูุฏ. ุจูุงุจุฑุงู ุงฺฏุฑ ุงุฒ multi-threading ูุฒ ุงุณุชูุงุฏู ฺฉููุ ุจูุจูุฏ ูุฎูุงูุฏ ุงูุช.

ุจู ุงู ุณุงุฎุชุงุฑ ุชูุฌู ฺฉูุฏ:

![ูุญูู ฺฉุงุฑ GIL](images/multi-process-programming.png)

ุฏุฑ `multi process programming` ูุง ุณุน ูฺฉูู ุจู ุฌุง ุงูฺฉู ุฏุฑูู ฺฉ processุ ฺฉุงุฑูุง ุจุดุชุฑ ุงูุฌุงู ุจุฏููุ ุชุนุฏุงุฏ process ุจุดุชุฑ ุฏุงุดุชู ุจุงุดู.
ุจู ุฒุจุงู ุฏฺฏุฑ ุงุฒ ุชุนุฏุงุฏ ูุณุชู ูุง CPU ุจุดุชุฑ ุงุณุชูุงุฏู ฺฉูู.

[ูุญุงุณุจู sqrt ุงุนุฏุงุฏ 1 ุชุง 50.000.000 ุจู ุตูุฑุช multi-process](./codes/multi_process_programming.py)

ุฏุฑ ุงู ูุซุงู ูุง ุงุฒ ูพฺฉุฌ `multiprocessing` ุจุฑุง ุจุฏุณุช ุขูุฑุฏู ูุณุชู ูุง CPU ุงุณุชูุงุฏู ฺฉุฑุฏู.

```python
processor_count = multiprocessing.cpu_count()
pool = multiprocessing.Pool()
tasks = []
for n in range(1, processor_count + 1):
    task = pool.apply_async(do_math, args=(50_000_000 * (n - 1) / processor_count, 50_000_000 * n / processor_count))
    tasks.append(task)

pool.close()
pool.join()
```

ุจุง ุงุณุชูุงุฏู ุงุฒ ุงู ุฑูุด ุณุฑุนุช ุงูุฌุงู ูุญุงุณุจุงุช ุงุฒ 8 ุซุงูู ุจู 1.5 ุซุงูู ฺฉุงูุด ูพุฏุง ฺฉุฑุฏ.

ุฑูุด ุงุฌุฑุง ฺฉุฏ ูุฒ ูุงุจู ุชูุฌู ุงุณุช!
```python
pool.close()
pool.join()
```

---
### ุฌูุณู 18
ุฏุฑ ูุซุงู ฺฉู ุฌูุณู ูพุด ุฑู ุขู ุชูุถุญ ุฏุงุฏูุ ุฎุฑูุฌ ุจุฑุง ูุง Return ููฺฉุฑุฏ.

ุจุฑุง ุงูฺฉู ุจุชูุงูู ูุชุฌู ฺฉ ูุญุงุณุจู ุฑู ุจุฏุณุช ุจุงุฑูุ ูุชููู ุจู ุตูุฑุช ุฒุฑ ุนูู ฺฉูู:
```python
tasks = []
for n in range(1, processor_count + 1):
    task = pool.apply_async(do_math, args=(50_000_000 * (n - 1) / processor_count, 50_000_000 * n / processor_count))
    tasks.append(task)

.
.
.

for t in tasks:
    print(t.get())
```

---
### ุฌูุณู 19
ุชุง ุงูุฌุง ฺฉุงุฑ ูุง ุจู ุตูุฑุช ุฏุณุช ูุฑุขูุฏ ูุง ูพุฑุฏุงุฒุด ุจู ุตูุฑุช `multi process` ู `multi thread` ุฑุง ูพุงุฏู ุณุงุฒ ฺฉุฑุฏู.

ุฏุฑ ุขูพุฏุช ูุง ุงุฎุฑ ูพุงุชูู ฺฉ API ุจุฑุง ุงูุฌุงู ุงู ฺฉุงุฑ ุงุฌุงุฏ ุดุฏู ุงุณุช ฺฉู ุฑุงุญุช ุชุฑ ูุชูุงูู ุงู ฺฉุงุฑ ุฑู ุงูุฌุงู ุจุฏูู.

ุจุฑุง ุงุณุชูุงุฏู ุงุฒ ุงู API ุจุงุฏ ุงุฒ ูพฺฉุฌ `concurrent` ุงุณุชูุงุฏู ฺฉูู.

ูุญูู ุงุณุชูุงุฏู ุงุฒ ุงู API ุฑุง ูุชูุงูุฏ ุฏุฑ ุงู ฺฉุฏ ูุดุงูุฏู ฺฉูุฏ:

[ูุญูู ุงุณุชูุงุฏู ุงุฒ ูพฺฉุฌ concurrent](./codes/concurrent_futures.py)

---
